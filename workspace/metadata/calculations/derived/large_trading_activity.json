{
  "calc_id": "large_trading_activity",
  "name": "Large Trading Activity",
  "layer": "derived",
  "description": "Flags trading activity as large when the total value exceeds a threshold multiplier of the average daily value. The threshold multiplier is resolved via the settings engine (varies by entity attributes). Also computes the activity score using graduated score steps.",
  "inputs": [
    {
      "source_type": "calculation",
      "calc_id": "trading_activity_aggregation",
      "fields": ["product_id", "account_id", "business_date", "buy_value", "sell_value"]
    },
    {
      "source_type": "setting",
      "setting_id": "large_activity_multiplier",
      "fields": ["multiplier"]
    }
  ],
  "output": {
    "table_name": "calc_large_trading_activity",
    "fields": [
      {"name": "product_id", "type": "varchar"},
      {"name": "account_id", "type": "varchar"},
      {"name": "business_date", "type": "date"},
      {"name": "total_value", "type": "decimal"},
      {"name": "is_large", "type": "boolean"},
      {"name": "threshold_used", "type": "decimal"}
    ]
  },
  "logic": "WITH activity_with_total AS (SELECT product_id, account_id, business_date, buy_value + sell_value AS total_value, buy_value, sell_value, buy_qty, sell_qty, total_trades, same_side_pct FROM calc_trading_activity), avg_activity AS (SELECT product_id, AVG(total_value) AS avg_daily_value FROM activity_with_total GROUP BY product_id) SELECT a.product_id, a.account_id, a.business_date, a.total_value, a.buy_value, a.sell_value, a.buy_qty, a.sell_qty, a.total_trades, a.same_side_pct, CASE WHEN a.total_value > COALESCE(avg.avg_daily_value, 0) * $activity_multiplier THEN TRUE ELSE FALSE END AS is_large, COALESCE(avg.avg_daily_value, 0) * $activity_multiplier AS threshold_used FROM activity_with_total a LEFT JOIN avg_activity avg ON a.product_id = avg.product_id",
  "parameters": {
    "activity_multiplier": {"source": "setting", "setting_id": "large_activity_multiplier", "default": 2.0}
  },
  "display": {
    "label": "Large Activity",
    "highlight_when": "is_large = TRUE"
  },
  "value_field": "total_value",
  "depends_on": ["trading_activity_aggregation"],
  "regulatory_tags": ["MAR Art. 12", "MAR Art. 16"]
}
