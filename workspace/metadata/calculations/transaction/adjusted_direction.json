{
  "calc_id": "adjusted_direction",
  "name": "Adjusted Direction",
  "layer": "transaction",
  "description": "Determines the effective buy/sell direction accounting for short instruments. Buying a put or selling a call is effectively selling. Selling a put or buying a call is effectively buying. For non-option instruments, the original side is preserved.",
  "inputs": [
    {
      "source_type": "calculation",
      "calc_id": "value_calc",
      "fields": ["execution_id", "side", "instrument_type"]
    }
  ],
  "output": {
    "table_name": "calc_adjusted_direction",
    "fields": [
      {"name": "execution_id", "type": "varchar"},
      {"name": "product_id", "type": "varchar"},
      {"name": "account_id", "type": "varchar"},
      {"name": "trader_id", "type": "varchar"},
      {"name": "original_side", "type": "varchar"},
      {"name": "adjusted_side", "type": "varchar"},
      {"name": "instrument_type", "type": "varchar"},
      {"name": "asset_class", "type": "varchar"},
      {"name": "price", "type": "decimal"},
      {"name": "quantity", "type": "decimal"},
      {"name": "calculated_value", "type": "decimal"},
      {"name": "execution_date", "type": "varchar"},
      {"name": "execution_time", "type": "varchar"}
    ]
  },
  "logic": "SELECT cv.execution_id, cv.product_id, cv.account_id, cv.trader_id, cv.side AS original_side, CASE WHEN cv.instrument_type = 'put_option' AND cv.side = 'BUY' THEN 'SELL' WHEN cv.instrument_type = 'call_option' AND cv.side = 'SELL' THEN 'SELL' WHEN cv.instrument_type = 'put_option' AND cv.side = 'SELL' THEN 'BUY' ELSE cv.side END AS adjusted_side, cv.instrument_type, cv.asset_class, cv.price, cv.quantity, cv.calculated_value, cv.execution_date, cv.execution_time FROM calc_value cv",
  "parameters": {},
  "display": {
    "label": "Adjusted Direction"
  },
  "value_field": "calculated_value",
  "depends_on": ["value_calc"],
  "regulatory_tags": ["MAR Art. 16", "MiFID II Art. 16(2)"]
}
